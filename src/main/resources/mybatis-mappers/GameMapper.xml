<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zw.admin.server.dao.GameDao">

    <sql id="whereUG">
        <where>
            <if test="userId != null and userId != ''">
                and ug.userId = #{userId}
            </if>
            <if test="gameId != null and gameId != 0">
                and ug.gameId = #{gameId}
            </if>
            <if test="isDefault != null and isDefault == 1">
                and g.isDefault = 1
            </if>
            <if test="isDefault != null and isDefault == 2">
                and g.isDefault = 0
            </if>
            and g.status=4
        </where>
    </sql>

    <delete id="delUG">
        delete from user_game 
        <where>
            <if test="userId != null and userId != ''">
                and userId = #{userId}
            </if>
            <if test="gameId != null and gameId != 0">
                and gameId = #{gameId}
            </if>
        </where>
    </delete>

    <select id="listUG" resultType="UserGame">
        select * from user_game ug
        LEFT JOIN game g ON g.id = ug.gameId
        <where>
        	<if test="userId != null and userId != ''">
                and ug.userId = #{userId}
            </if>
            <if test="gameId != null and gameId != 0">
                and ug.gameId = #{gameId}
            </if>
        </where>
    </select>

    <select id="listRf" resultType="com.zw.admin.server.model.Game">
        select t.* from game t left join file_info f on t.name = f.name
        <where>
            <if test="id != null and id != 0">
                and t.id = #{id}
            </if>
            <if test="isDefault != null and isDefault == 1">
                and t.isDefault = 1
            </if>
            <if test="isDefault != null and isDefault == 2">
                and t.isDefault = 0
            </if>
            <if test="platform !=null and platform !=''">
                and f.platform = #{platform}
            </if>
            and t.status = 4
        </where>
        group by t.id
    </select>

    <sql id="where">
        <where>
            <if test="params.id != null and params.id != ''">
                and id = #{params.id}
            </if>
            <if test="params.userId != null and params.userId != ''">
                and userId = #{params.userId}
            </if>
            <if test="params.name != null and params.name != ''">
                and name = #{params.name}
            </if>
            <if test="params.gamename != null and params.gamename != ''">
                and gamename = #{params.gamename}
            </if>
            <if test="params.modulename != null and params.modulename != ''">
                and modulename = #{params.modulename}
            </if>
            <if test="params.pic != null and params.pic != ''">
                and pic = #{params.pic}
            </if>
            <if test="params.description != null and params.description != ''">
                and description = #{params.description}
            </if>
            <if test="params.isDefault != null and params.isDefault != ''">
                and isDefault = #{params.isDefault}
            </if>
            <if test="params.type != null and params.type != ''">
                and type = #{params.type}
            </if>
            <if test="params.mode != null and params.mode != ''">
                and mode = #{params.mode}
            </if>
            <if test="params.categoty != null and params.categoty != ''">
                and categoty = #{categoty}
            </if>
            <if test="params.deviceType != null and params.deviceType != ''">
                and deviceType = #{deviceType}
            </if>
            <if test="params.icon != null and params.icon != ''">
                and icon = #{params.icon}
            </if>
            <if test="params.status != null and params.status != ''">
                and status = #{params.status}
            </if>
            <if test="params.createTime != null and params.createTime != ''">
                and createTime = #{params.createTime}
            </if>
            <if test="params.updateTime != null and params.updateTime != ''">
                and updateTime = #{params.updateTime}
            </if>

        </where>
    </sql>
    
    <sql id="webWhere">
    	<where>
            <if test="params.id != null and params.id != ''">
                and id = #{params.id}
            </if>
            <if test="params.userId != null and params.userId != ''">
                and userId = #{params.userId}
            </if>
            <if test="params.name != null and params.name != ''">
                and name = #{params.name}
            </if>
            <if test="params.isDefault != null ">
                and isDefault = #{params.isDefault}
            </if>
            <if test="params.status != null and params.status != ''">
                and status = #{params.status}
            </if>
            <if test ="params.buy  != null and params.buy == 0">
		        and gg.gid is null
		    </if>
		    <if test ="params.buy  != null and params.buy == 1">
		        and gg.gid is not null
		    </if>
		    <if test="params.type != null and params.type != ''">
                and type = #{params.type}
            </if>
            <if test="params.unmode != null and params.unmode != '' " >
                and mode != '0'
            </if>
            <if test ="params.mode != null and params.mode != ''">
		        and mode = #{params.mode}
		    </if>
            <if test="params.categoty != null and params.categoty != ''">
                and categoty = #{params.categoty}
            </if>
             <if test="params.deviceType != null and params.deviceType != ''">
                and deviceType like CONCAT(CONCAT('%',#{params.deviceType},'%'))
            </if>           
        </where>
      </sql>

    <select id="count" resultType="int">
        select count(1) from game t
        <include refid="where"/>
    </select>

    <select id="list" resultType="Game">
        select * from game t
        <include refid="where"/>
        ${params.orderBy}
        limit #{offset}, #{limit}
    </select>
    
     <select id="webCount" resultType="int">
        select  count(1)
		FROM
			game t
		left JOIN (
			SELECT
				g.id AS gid
			FROM
				game g
			WHERE
				EXISTS (
					SELECT
						ug.gameId
					FROM
						user_game ug
					<where>
						<if test="params.buyerId != null and params.buyerId != ''">
							ug.userId = #{params.buyerId}
							and ug.isBuy=1
						</if>
						AND g.id = ug.gameId
					</where>
				)
		) gg  ON  gg.gid = t.id
		<include refid="webWhere"/>
    </select>
    
   <select id="apiList" resultType="Game">
        select  t.*
		FROM
			game t
		INNER JOIN (
			SELECT
				g.id AS gid
			FROM
				game g
			WHERE
				EXISTS (
					SELECT
						ug.gameId
					FROM
						user_game ug
					<where>
						<if test="params.buyerId != null and params.buyerId != ''">
							ug.userId = #{params.buyerId}
						</if>
						<if test="params.isBuy != null ">
							and ug.isBuy=#{params.isBuy}
						</if>
					AND g.id = ug.gameId
					</where>
				)
		) gg  ON  gg.gid = t.id
		 <include refid="webWhere"/>
         ORDER BY createTime desc
        <if test="limit != null and limit != 0">
            limit #{offset}, #{limit}
        </if>
    </select>

    <select id="webList" resultType="Game">
        select  t.*,
        	CASE
		WHEN ISNULL(gg.gid) THEN
			0
		ELSE
			1
		END AS ugStatus
		FROM
			game t
		LEFT JOIN (
			SELECT
				g.id AS gid
			FROM
				game g
			WHERE
				EXISTS (
					SELECT
						ug.gameId
					FROM
						user_game ug
					<where>
						<if test="params.buyerId != null and params.buyerId != ''">
							ug.userId = #{params.buyerId}
							and ug.isBuy=1
						</if>
					AND g.id = ug.gameId
					</where>
				)
		) gg  ON  gg.gid = t.id
		 <include refid="webWhere"/>
         ORDER BY status asc ,createTime desc  
        <if test="limit != null and limit != 0">
            limit #{offset}, #{limit}
        </if>
    </select>
    
      <update id="updateUserGame">
        update user_game t
        <set>
            <if test="isBuy != null">
                isBuy = #{isBuy}
            </if>
        </set>
        where t.id = #{id}
    </update>

    <update id="update">
        update game t
        <set>
            <if test="userId != null">
                userId = #{userId},
            </if>
            <if test="name != null">
                name = #{name},
            </if>
            <if test="gamename != null">
                gamename = #{gamename},
            </if>
            <if test="modulename != null">
                modulename = #{modulename},
            </if>
            <if test="pic != null">
                pic = #{pic},
            </if>
            <if test="description != null">
                description = #{description},
            </if>
            <if test="isDefault != null">
                isDefault = #{isDefault},
            </if>
            <if test="type != null">
                type = #{type},
            </if>
            <if test="mode != null">
                mode = #{mode},
            </if>
            <if test="categoty != null">
                categoty = #{categoty},
            </if>
            <if test="deviceType != null">
               deviceType = #{deviceType},
            </if>              
            <if test="icon != null">
                icon = #{icon},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="createTime != null">
                createTime = #{createTime},
            </if>
            <if test="updateTime != null">
                updateTime = #{updateTime},
            </if>

        </set>

        where t.id = #{id}
    </update>

    <!--根据游戏的id和游戏状态查询游戏-->
    <select id="getGameById" parameterType="Game" resultType="Game">
        select id,name,gamename from game
        <where>
            id = #{id}
            <if test="status !=null">
                and status = #{id}
            </if>
        </where>
    </select>

    <!--游戏列表下拉框-->
    <select id="selectGameNameList" resultType="java.lang.String">
        select gamename from game
    </select>

    <!--查询需要更新的列表-->
    <select id="selectGameFileList" resultType="com.zw.admin.server.dto.GameFileResDto">
        select f.* from game t left join file_info f on t.name = f.name
        <where>
            <if test="id != null and id != 0">
                and t.id = #{id}
            </if>
            <if test="isDefault != null and isDefault == 1">
                and t.isDefault = 1
            </if>
            <if test="isDefault != null and isDefault == 2">
                and t.isDefault = 0
            </if>
            <if test="platform !=null and platform !=''">
                and f.platform = #{platform}
            </if>
            <if test="type !=null and platform !=''">
                and f.type = #{type}
            </if>
            and t.status = 4
        </where>
        group by t.id
    </select>

    <!--批量添加游戏与人的映射，提高效率-->
    <insert id="saveUGBatch">
        insert into user_game(userId, username, gameId, gamename,isBuy) values
        <foreach collection="list" item="item" separator=",">
            (#{item.userId}, #{item.username},#{item.gameId}, #{item.gamename}, #{item.isBuy})
        </foreach>
    </insert>

    <!--删除用户与游戏关联-->
    <delete id="deleteUserGame">
        delete from user_game where userId = #{userId} and gameId = #{gameId}
    </delete>
</mapper>
