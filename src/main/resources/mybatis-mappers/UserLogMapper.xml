<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zw.admin.server.dao.UserLogDao">

    <sql id="where">
        <where>
            <if test="params.id != null and params.id != ''">
                and id = #{params.id}
            </if>
            <if test="params.userId != null and params.userId != ''">
                and user_id = #{params.userId}
            </if>
            <if test="params.machineId != null and params.machineId != ''">
                and machine_id = #{params.machineId}
            </if>
            <if test="params.machineType != null and params.machineType != ''">
                and machine_type = #{params.machineType}
            </if>
            <if test="params.ip != null and params.ip != ''">
                and ip = #{params.ip}
            </if>
            <if test="params.updateTime != null and params.updateTime != ''">
                and update_time = #{params.updateTime}
            </if>
            <if test="params.createTime != null and params.createTime != ''">
                and create_time = #{params.createTime}
            </if>
            <if test="params.rupsVer != null and params.rupsVer != ''">
                and rups_ver = #{params.rupsVer}
            </if>
            <if test="params.time != null and params.time != ''">
                and time = #{params.time}
            </if>
        </where>
    </sql>

    <sql id="selectByMachineId">
        machine_type !='Mouse'
        <if test="list !=null and list.size >0">
            and machine_id in
            <foreach collection="list" item="var" separator="," open="(" close=")">
                #{var}
            </foreach>
        </if>
    </sql>

    <sql id="selectByMachineIdTrendChart">
        <where>
            <if test="list !=null and list.size >0">
                machine_id in
                <foreach collection="list" item="item" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
            <if test="week !=null">
                YEARWEEK(
                date_format(create_time, '%Y-%m-%d'),
                1
                ) = YEARWEEK(now(), 1)
            </if>
        </where>
    </sql>

    <select id="count" resultType="int">
        select count(1) from user_log t
        <include refid="where"/>
    </select>

    <select id="list" resultType="UserLog">
        select * from user_log t
        <include refid="where"/>
        ${params.orderBy} limit #{offset}, #{limit}
    </select>

    <update id="update">
        update user_log t
        <set>
            <if test="userId != null">
                user_id = #{userId},
            </if>
            <if test="machineId != null">
                machine_id = #{machineId},
            </if>
            <if test="machineType != null">
                machine_type = #{machineType},
            </if>
            <if test="ip != null">
                ip = #{ip},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
            <if test="createTime != null">
                create_time = #{createTime},
            </if>
            <if test="rupsVer != null">
                rups_ver = #{rupsVer},
            </if>
            <if test="time != null">
                time = #{time},
            </if>
        </set>
        where t.log_id = #{logId}
    </update>

    <select id="checkExists" resultType="com.zw.admin.server.model.UserLog">
        SELECT
            id,user_id,machine_id,rups_ver
        FROM
            user_log
        WHERE
            machine_id = #{machineId}
        and user_id=#{userId}
         and update_time=#{updateTime}
         limit 1
    </select>

    <!--设备使用总时长-->
    <select id="selectTotalMachineUseTime" resultType="java.lang.Long">
        SELECT IFNULL(sum(time),0) from user_log
        <where>
            <include refid="selectByMachineId"/>
        </where>
    </select>

    <!--各设备使用总时长-->
    <select id="selectMachineUseTimeByType" resultType="com.zw.admin.server.dto.MachineNumDto">
        SELECT machine_type ,IFNULL(sum(time),0) num from user_log
        <where>
            <include refid="selectByMachineId"/>
        </where>
        group by machine_type order by num desc
    </select>

    <!--本周，本月，本年设备趋势-->
    <select id="selectMachineUseTimeTrendChart" resultType="com.zw.admin.server.dto.DateNumDto">
        SELECT
        <if test='dateType == "week" or dateType == "month"'>
            DATE_FORMAT(update_time, '%Y-%m-%d')
        </if>
        <if test='dateType == "year"'>
            DATE_FORMAT(update_time, '%Y-%m')
        </if>
        date,sum(IFNULL(time,0)) num
        FROM
        user_log
        <where>
            <include refid="selectByMachineId"></include>
            <if test='dateType == "week"'>
                and YEARWEEK(date_format(update_time, '%Y-%m-%d'),1) = YEARWEEK(now(), 1)
            </if>
            <if test='dateType == "month"'>
                and DATE_FORMAT( update_time, '%Y%m' ) = DATE_FORMAT( CURDATE( ) , '%Y%m' )
            </if>
            <if test='dateType == "year"'>
                and YEAR(update_time)=YEAR(NOW())
            </if>
        </where>
        group by
        <if test='dateType == "week" or dateType == "month"'>
            DATE_FORMAT(update_time, '%Y-%m-%d')
        </if>
        <if test='dateType == "year"'>
            DATE_FORMAT(update_time, '%Y-%m')
        </if>
    </select>

    <select id="countUserLogByLogId" resultType="java.lang.Integer">
        select count(1) from user_log where log_id = #{logId}
    </select>
</mapper>